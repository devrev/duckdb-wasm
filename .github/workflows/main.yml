name: "publish package"
on:
  push:
    branches:
      - master
      - main
jobs:
  publish-npm:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          ref: 'v1.28.0branch'
      - uses: actions/setup-node@v3
        with:
          node-version: 18.17
          registry-url: https://npm.pkg.github.com/
          scope: '@devrev'
      - run: npm install -g yarn
      - run: |
          git submodule init
          git submodule update
          # Install package
          sudo apt install -y ccache
          sudo /usr/sbin/update-ccache-symlinks
          echo 'export PATH="/usr/lib/ccache:$PATH"' | tee -a ~/.bashrc
          sudo apt-get install emscripten  


          source ~/.bashrc && echo $PATH
          DUCKDB_JSON=1 make wasm
          cd packages/duckdb-wasm
          yarn install && yarn build:release
          echo "//npm.pkg.github.com/:_authToken=${{secrets.NPM_PACKAGE_PUBLISH_TOKEN}}" >> .npmrc
          npm publish
